>.<

Title: Vehicle Gear Usage
Link: https://platform.stratascratch.com/coding/10571-vehicle-gear-usage?code_type=3
Level: Medium

A company tracks data from its delivery vehicles. 
Every time a driver changes gears, the system records which vehicle ('car_id'), when it happened (timestamp in Unix epoch seconds), and which gear: P (Park), D (Drive), or R (Reverse).
Calculate how many total hours all vehicles spent in each gear.
To determine the duration of a gear period, calculate the time difference between when that gear was engaged and when the next gear change occurred.
For each vehicle's final gear change (which has no subsequent change recorded), assume the shift ended 2 hours after that final timestamp.
Return gear and total hours.

Data vehicle_telemetry:
car_id: text
timestamp_epoch: bigint
gear: text

>.<

Solution:

with gear_durations as (
select car_id,gear,timestamp_epoch,lead(timestamp_epoch) over (partition by car_id order by timestamp_epoch) as next_timestamp
from vehicle_telemetry
),
calculated as (
select gear,
case
when next_timestamp is not null then next_timestamp - timestamp_epoch
else 7200
end as duration_seconds
from gear_durations
)
select gear, sum(duration_seconds)/3600.0 as total_hours
from calculated
group by gear
order by gear;
    
Output:

gear	total_hours
D	38.17
P	33.75
R	0.33
